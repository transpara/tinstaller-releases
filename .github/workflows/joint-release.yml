name: Generate Joint Release Notes
on:
  push:
    tags:
      - '*.*.*'
  workflow_dispatch:

jobs:
  build-release-notes:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Generate Notes
        id: generate_notes
        env:
          GH_TOKEN: ${{ secrets.READ_ALL_TOKEN }}
          ORG: "transpara"
          INSTALLER_REPO: "tinstaller-releases"
        run: |
          COMPONENTS=("tstudio-py" "tview" "tgraph-api" "tsystem" "tcalc" "tauth-scraper" "tstore-interface" "extractor-telegraf" "extractor-opcua" "extractor_odbc")
          
          # Get the date of the PREVIOUS release
          LAST_RELEASE_DATE=$(gh release list --repo "$ORG/$INSTALLER_REPO" --limit 2 --json publishedAt --jq '.[1].publishedAt')
          if [ -z "$LAST_RELEASE_DATE" ]; then LAST_RELEASE_DATE="1970-01-01T00:00:00Z"; fi

          # Identify which tag to update
          # If github.ref_name is a tag (from push tags), use it. 
          # Otherwise (workflow_dispatch), fetch the latest tag from the API.
          if [[ "${{ github.ref_type }}" == "tag" ]]; then
            TARGET_TAG="${{ github.ref_name }}"
          else
            TARGET_TAG=$(gh release list --repo "$GITHUB_REPOSITORY" --limit 1 --json tagName --jq '.[0].tagName')
          fi
          echo "target_tag=$TARGET_TAG" >> $GITHUB_ENV

          {
            echo "## Joint Release Notes"
            echo "Aggregated updates since: $LAST_RELEASE_DATE"
            echo ""
            
            for REPO in "${COMPONENTS[@]}"; do
                NEW_TAGS=$(gh release list --repo "$ORG/$REPO" --json tagName,publishedAt | \
                jq -r ".[] | select(.publishedAt > \"$LAST_RELEASE_DATE\") | .tagName")

                if [ -n "$NEW_TAGS" ]; then
                    echo "### $REPO"
                    for TAG in $NEW_TAGS; do
                        echo "#### Release: $TAG"
                        gh release view "$TAG" --repo "$ORG/$REPO" --json body --template '{{.body}}'
                        echo -e "\n"
                    done
                    echo "---"
                fi
            done
          } > JOINT_RELEASE_NOTES.md
          cat JOINT_RELEASE_NOTES.md
          
      - name: Update Release
        uses: softprops/action-gh-release@v1
        with:
          tag_name: ${{ env.target_tag }}
          body_path: JOINT_RELEASE_NOTES.md
          append_body: true
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
